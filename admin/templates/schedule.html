{% extends "base.html" %}

{% block page_actions %}
{% if selected_staff %}
<div class="btn-toolbar mb-2 mb-md-0">
    <form id="apply-default-form" method="post" action="/schedule/apply-default">
        <input type="hidden" name="staff_id" value="{{ selected_staff.id }}">
    </form>
    <button class="btn btn-sm btn-secondary me-2" onclick="applyDefaultSchedule({{ selected_staff.id }})">
        <i class="fas fa-clock"></i> Apply Default Schedule
    </button>
</div>
{% endif %}
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Select Staff Member</h5>
                </div>
                <div class="card-body">
                    <form action="/schedule" method="get">
                        <div class="row">
                            <div class="col-md-6">
                                <select name="staff_id" class="form-select" onchange="this.form.submit()">
                                    <option value="">-- Select Staff Member --</option>
                                    {% for staff in staff_members %}
                                    <option value="{{ staff.id }}" {% if selected_staff and selected_staff.id == staff.id %}selected{% endif %}>
                                        {{ staff.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    {% if selected_staff %}
    <div class="row">
        <div class="col">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Schedule for {{ selected_staff.name }}</h5>
                        {% if not selected_staff.is_active %}
                        <span class="badge bg-danger">Inactive Staff</span>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">
                    <form method="post" action="/schedule/bulk-update">
                        <input type="hidden" name="staff_id" value="{{ selected_staff.id }}">
                        
                        <div class="table-responsive">
                            <table class="table table-bordered schedule-table">
                                <thead>
                                    <tr>
                                        <th>Day</th>
                                        <th>Working Day</th>
                                        <th>Start Time</th>
                                        <th>End Time</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for day in weekdays %}
                                    <tr>
                                        <td>{{ day.name }}</td>
                                        <td>
                                            <div class="form-check form-switch">
                                                <input class="form-check-input working-day-toggle" type="checkbox" 
                                                       id="is_working_day_{{ day.id }}" name="is_working_day_{{ day.id }}" 
                                                       data-weekday="{{ day.id }}"
                                                       {% if weekday_schedules[day.id] %}checked{% endif %}>
                                            </div>
                                        </td>
                                        <td>
                                            <input type="time" class="form-control time-field-{{ day.id }}" 
                                                   id="start_time_{{ day.id }}" name="start_time_{{ day.id }}" 
                                                   value="{{ weekday_schedules[day.id].start_time if weekday_schedules[day.id] else '09:00' }}"
                                                   {% if not weekday_schedules[day.id] %}disabled{% endif %}>
                                        </td>
                                        <td>
                                            <input type="time" class="form-control time-field-{{ day.id }}" 
                                                   id="end_time_{{ day.id }}" name="end_time_{{ day.id }}" 
                                                   value="{{ weekday_schedules[day.id].end_time if weekday_schedules[day.id] else '17:00' }}"
                                                   {% if not weekday_schedules[day.id] %}disabled{% endif %}>
                                        </td>
                                        <td>
                                            <button type="button" class="btn btn-sm btn-secondary" 
                                                    onclick="copyToAll({{ day.id }})">
                                                Copy to All
                                            </button>
                                            
                                            <form method="post" action="/schedule/update" style="display:inline-block;">
                                                <input type="hidden" name="staff_id" value="{{ selected_staff.id }}">
                                                <input type="hidden" name="weekday" value="{{ day.id }}">
                                                <input type="hidden" name="is_working_day" value="{{ 'true' if weekday_schedules[day.id] else 'false' }}">
                                                <input type="hidden" name="start_time" 
                                                       value="{{ weekday_schedules[day.id].start_time if weekday_schedules[day.id] else '09:00' }}">
                                                <input type="hidden" name="end_time" 
                                                       value="{{ weekday_schedules[day.id].end_time if weekday_schedules[day.id] else '17:00' }}">
                                                <button type="submit" class="btn btn-sm btn-primary">
                                                    Save
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="mt-3">
                            <button type="submit" class="btn btn-primary">Save All Changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}
